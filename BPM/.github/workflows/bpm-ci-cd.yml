# ğŸ“ C:\xampp\htdocs\BPM\.github\workflows\bmp-ci-cd.yml
# Create at 2508031152 Ver1.00

name: BPM CI/CD Pipeline

# ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° ì¡°ê±´
on:
  push:
    branches: 
      - main
      - develop
      - 'feature/*'
      - 'hotfix/*'
  pull_request:
    branches: 
      - main
      - develop
  release:
    types: [published]

# í™˜ê²½ ë³€ìˆ˜ ì •ì˜
env:
  PHP_VERSION: '8.1'
  NODE_VERSION: '18'
  COMPOSER_CACHE_DIR: ~/.composer/cache
  NODE_CACHE_DIR: ~/.npm

# ì‘ì—… ì •ì˜
jobs:
  # 1ë‹¨ê³„: ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  code-quality:
    name: ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
    runs-on: ubuntu-latest
    
    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # SonarQube ë¶„ì„ì„ ìœ„í•œ ì „ì²´ íˆìŠ¤í† ë¦¬

      - name: PHP í™˜ê²½ ì„¤ì •
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, ctype, iconv, intl, pdo, pdo_mysql, redis
          coverage: xdebug
          tools: composer:v2

      - name: Composer ìºì‹œ ì„¤ì •
        uses: actions/cache@v3
        with:
          path: ${{ env.COMPOSER_CACHE_DIR }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Composer ì˜ì¡´ì„± ì„¤ì¹˜
        run: composer install --no-progress --prefer-dist --optimize-autoloader

      - name: PHP ë¬¸ë²• ê²€ì‚¬
        run: |
          find . -name "*.php" -not -path "./vendor/*" -exec php -l {} \; | grep -v "No syntax errors"

      - name: PHP_CodeSniffer ì½”ë“œ ìŠ¤íƒ€ì¼ ê²€ì‚¬
        run: |
          composer require --dev squizlabs/php_codesniffer
          ./vendor/bin/phpcs --standard=PSR12 --extensions=php --ignore=vendor/ .

      - name: PHPStan ì •ì  ë¶„ì„
        run: |
          composer require --dev phpstan/phpstan
          ./vendor/bin/phpstan analyse --level=5 core/ modules/ includes/

      - name: PHPMD ë³µì¡ë„ ë¶„ì„
        run: |
          composer require --dev phpmd/phpmd
          ./vendor/bin/phpmd core/,modules/,includes/ text cleancode,codesize,controversial,design,naming,unusedcode

  # 2ë‹¨ê³„: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
  unit-tests:
    name: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: code-quality

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ALLOW_EMPTY_PASSWORD: yes
          MYSQL_DATABASE: bpm_test
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: --health-cmd="redis-cli ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: PHP í™˜ê²½ ì„¤ì •
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, ctype, iconv, intl, pdo, pdo_mysql, redis, xdebug
          coverage: xdebug

      - name: Composer ìºì‹œ ë³µì›
        uses: actions/cache@v3
        with:
          path: ${{ env.COMPOSER_CACHE_DIR }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}

      - name: Composer ì˜ì¡´ì„± ì„¤ì¹˜
        run: composer install --no-progress --prefer-dist

      - name: í…ŒìŠ¤íŠ¸ í™˜ê²½ ì„¤ì •
        run: |
          cp .env.testing .env
          php artisan key:generate --env=testing
          php artisan config:clear

      - name: ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜
        run: |
          mysql -h127.0.0.1 -uroot bpm_test < sql/schema.sql
          mysql -h127.0.0.1 -uroot bmp_test < sql/test-data.sql

      - name: PHPUnit í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: |
          composer require --dev phpunit/phpunit
          ./vendor/bin/phpunit --configuration tests/phpunit.xml --coverage-clover=coverage.xml

      - name: ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

  # 3ë‹¨ê³„: í†µí•© í…ŒìŠ¤íŠ¸ (Playwright)
  integration-tests:
    name: í†µí•© í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: unit-tests

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ALLOW_EMPTY_PASSWORD: yes
          MYSQL_DATABASE: bpm_integration
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379

    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js í™˜ê²½ ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: PHP í™˜ê²½ ì„¤ì •
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, ctype, iconv, intl, pdo, pdo_mysql, redis

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          composer install --no-dev --optimize-autoloader
          npm ci

      - name: Playwright ì„¤ì¹˜
        run: npx playwright install --with-deps

      - name: í…ŒìŠ¤íŠ¸ ì„œë²„ ì‹œì‘
        run: |
          cp .env.testing .env
          mysql -h127.0.0.1 -uroot bmp_integration < sql/schema.sql
          php -S localhost:8000 -t . &
          sleep 5

      - name: Playwright í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: npx playwright test

      - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

  # 4ë‹¨ê³„: ë³´ì•ˆ ìŠ¤ìº”
  security-scan:
    name: ë³´ì•ˆ ìŠ¤ìº”
    runs-on: ubuntu-latest
    needs: code-quality

    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: PHP í™˜ê²½ ì„¤ì •
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}

      - name: Composer ë³´ì•ˆ ê°ì‚¬
        run: |
          composer audit

      - name: Node.js ë³´ì•ˆ ê°ì‚¬
        run: |
          npm audit --audit-level moderate

      - name: SAST ìŠ¤ìº” (SonarCloud)
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'BPM'
          path: '.'
          format: 'JSON'
          out: 'reports'

      - name: Snyk ë³´ì•ˆ ìŠ¤ìº”
        uses: snyk/actions/php@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

  # 5ë‹¨ê³„: ë¹Œë“œ ë° ë„ì»¤ ì´ë¯¸ì§€ ìƒì„±
  build:
    name: ë¹Œë“œ ë° ì´ë¯¸ì§€ ìƒì„±
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, security-scan]
    if: github.ref == 'refs/heads/main' || github.event_name == 'release'

    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Docker Buildx ì„¤ì •
        uses: docker/setup-buildx-action@v3

      - name: Docker Hub ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: bpm/app
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile.prod
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

  # 6ë‹¨ê³„: ìŠ¤í…Œì´ì§• ë°°í¬
  deploy-staging:
    name: ìŠ¤í…Œì´ì§• ë°°í¬
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop'
    environment: staging

    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: AWS ìê²©ì¦ëª… ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: ECS íƒœìŠ¤í¬ ì •ì˜ ì—…ë°ì´íŠ¸
        run: |
          aws ecs update-service \
            --cluster bpm-staging \
            --service bmp-app \
            --force-new-deployment

      - name: ë°°í¬ ìƒíƒœ í™•ì¸
        run: |
          aws ecs wait services-stable \
            --cluster bpm-staging \
            --services bmp-app

      - name: í—¬ìŠ¤ì²´í¬
        run: |
          curl -f https://staging.bpm.example.com/health || exit 1

  # 7ë‹¨ê³„: í”„ë¡œë•ì…˜ ë°°í¬
  deploy-production:
    name: í”„ë¡œë•ì…˜ ë°°í¬
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'release'
    environment: production

    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: AWS ìê²©ì¦ëª… ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_PROD }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_PROD }}
          aws-region: ap-northeast-2

      - name: ë¸”ë£¨-ê·¸ë¦° ë°°í¬ ì‹œì‘
        run: |
          # ìƒˆë¡œìš´ íƒœìŠ¤í¬ ì •ì˜ ìƒì„±
          TASK_DEFINITION=$(aws ecs describe-task-definition \
            --task-definition bpm-prod \
            --query taskDefinition)
          
          # ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸
          NEW_TASK_DEFINITION=$(echo $TASK_DEFINITION | \
            jq --arg IMAGE "${{ needs.build.outputs.image-tag }}" \
            '.containerDefinitions[0].image = $IMAGE')
          
          # ìƒˆ íƒœìŠ¤í¬ ì •ì˜ ë“±ë¡
          aws ecs register-task-definition \
            --cli-input-json "$NEW_TASK_DEFINITION"

      - name: ì„œë¹„ìŠ¤ ì—…ë°ì´íŠ¸
        run: |
          aws ecs update-service \
            --cluster bmp-production \
            --service bpm-app \
            --task-definition bpm-prod

      - name: ë°°í¬ ìƒíƒœ ëª¨ë‹ˆí„°ë§
        run: |
          aws ecs wait services-stable \
            --cluster bpm-production \
            --services bmp-app

      - name: í”„ë¡œë•ì…˜ í—¬ìŠ¤ì²´í¬
        run: |
          for i in {1..10}; do
            if curl -f https://api.bpm.example.com/health; then
              echo "í—¬ìŠ¤ì²´í¬ ì„±ê³µ"
              break
            fi
            echo "í—¬ìŠ¤ì²´í¬ ì‹œë„ $i/10 ì‹¤íŒ¨, 30ì´ˆ ëŒ€ê¸°..."
            sleep 30
          done

      - name: ë¡¤ë°± ìŠ¤í¬ë¦½íŠ¸ ì¤€ë¹„
        if: failure()
        run: |
          echo "ë°°í¬ ì‹¤íŒ¨, ë¡¤ë°± ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰"
          aws ecs update-service \
            --cluster bpm-production \
            --service bpm-app \
            --task-definition bpm-prod:$(( $(aws ecs describe-services --cluster bpm-production --services bpm-app --query 'services[0].taskDefinition' --output text | cut -d':' -f2) - 1 ))

  # 8ë‹¨ê³„: ì•Œë¦¼ ë° ë¦¬í¬íŒ…
  notify:
    name: ë°°í¬ ê²°ê³¼ ì•Œë¦¼
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always()

    steps:
      - name: Slack ì•Œë¦¼
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          fields: repo,message,commit,author,action,eventName,ref,workflow

      - name: ì´ë©”ì¼ ì•Œë¦¼
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: '[BPM] ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼'
          body: |
            BPM ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.
            
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref }}
            Commit: ${{ github.sha }}
            Workflow: ${{ github.workflow }}
            
            ìì„¸í•œ ë‚´ìš©ì€ GitHub Actionsì—ì„œ í™•ì¸í•˜ì„¸ìš”.
          to: dev-team@bpm.example.com
          from: noreply@bpm.example.com

  # 9ë‹¨ê³„: ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
  performance-monitoring:
    name: ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
    runs-on: ubuntu-latest
    needs: deploy-production
    if: github.event_name == 'release'

    steps:
      - name: Lighthouse CI ì„±ëŠ¥ ì¸¡ì •
        run: |
          npm install -g @lhci/cli
          lhci autorun --upload.target=filesystem --upload.outputDir=./lighthouse-results

      - name: ì„±ëŠ¥ ê²°ê³¼ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v3
        with:
          name: lighthouse-results
          path: lighthouse-results/

      - name: ì„±ëŠ¥ ì„ê³„ê°’ í™•ì¸
        run: |
          # Lighthouse ì ìˆ˜ê°€ 90 ë¯¸ë§Œì´ë©´ ê²½ê³ 
          PERFORMANCE_SCORE=$(cat lighthouse-results/manifest.json | jq '.[] | .summary.performance' | head -1)
          if (( $(echo "$PERFORMANCE_SCORE < 0.9" | bc -l) )); then
            echo "âš ï¸ ì„±ëŠ¥ ì ìˆ˜ê°€ 90 ë¯¸ë§Œì…ë‹ˆë‹¤: $PERFORMANCE_SCORE"
            exit 1
          fi

# ì›Œí¬í”Œë¡œìš° ìˆ˜ì¤€ í™˜ê²½ ë³€ìˆ˜
env:
  FORCE_COLOR: 3
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

# ë™ì‹œ ì‹¤í–‰ ì œí•œ (ê°™ì€ ë¸Œëœì¹˜ì—ì„œëŠ” ìµœì‹  ê²ƒë§Œ ì‹¤í–‰)
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true