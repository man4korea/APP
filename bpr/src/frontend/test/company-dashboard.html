<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BPR Hub - íšŒì‚¬ ëŒ€ì‹œë³´ë“œ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f5f5f5; }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
        .card { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        h1 { color: #2563eb; margin-bottom: 5px; }
        h2 { color: #374151; margin-bottom: 15px; }
        h3 { color: #4b5563; margin-bottom: 10px; }
        
        .company-info { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; text-align: center; }
        .stat-number { font-size: 2em; font-weight: bold; margin-bottom: 5px; }
        .stat-label { font-size: 0.9em; opacity: 0.9; }
        
        .user-menu { position: relative; }
        .user-avatar { width: 40px; height: 40px; background-color: #2563eb; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; cursor: pointer; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; text-decoration: none; display: inline-block; text-align: center; margin: 5px; transition: all 0.2s; }
        .btn-primary { background-color: #2563eb; color: white; }
        .btn-primary:hover { background-color: #1d4ed8; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .btn-secondary:hover { background-color: #4b5563; }
        .btn-success { background-color: #059669; color: white; }
        .btn-success:hover { background-color: #047857; }
        .btn-danger { background-color: #dc2626; color: white; }
        .btn-danger:hover { background-color: #b91c1c; }
        .btn-small { padding: 6px 12px; font-size: 12px; }
        
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        th { background-color: #f9fafb; font-weight: 600; color: #374151; }
        tr:hover { background-color: #f9fafb; }
        
        .status-badge { padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
        .status-active { background-color: #d1fae5; color: #059669; }
        .status-pending { background-color: #fef3c7; color: #f59e0b; }
        .status-inactive { background-color: #fee2e2; color: #dc2626; }
        
        .tabs { border-bottom: 2px solid #e5e7eb; margin-bottom: 20px; }
        .tab { display: inline-block; padding: 10px 20px; cursor: pointer; border-bottom: 2px solid transparent; color: #6b7280; font-weight: 500; }
        .tab.active { color: #2563eb; border-bottom-color: #2563eb; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .info-item { padding: 15px; background-color: #f9fafb; border-radius: 8px; }
        .info-label { font-weight: 600; color: #6b7280; font-size: 12px; text-transform: uppercase; margin-bottom: 5px; }
        .info-value { color: #111827; font-size: 14px; }
        
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .alert-info { background-color: #eff6ff; border-left: 4px solid #2563eb; color: #1e40af; }
        .alert-warning { background-color: #fef3c7; border-left: 4px solid #f59e0b; color: #92400e; }
        .alert-success { background-color: #d1fae5; border-left: 4px solid #059669; color: #047857; }
        
        .empty-state { text-align: center; padding: 40px; color: #6b7280; }
        .empty-state-icon { font-size: 48px; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <!-- í—¤ë” -->
        <div class="header">
            <div>
                <h1 id="companyName">íšŒì‚¬ëª…</h1>
                <p id="companyType">ë³¸ì </p>
            </div>
            <div class="user-menu">
                <div class="user-avatar" id="userAvatar">U</div>
            </div>
        </div>

        <!-- í†µê³„ ì¹´ë“œ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="memberCount">0</div>
                <div class="stat-label">êµ¬ì„±ì›</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="processCount">0</div>
                <div class="stat-label">í”„ë¡œì„¸ìŠ¤</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="branchCount">0</div>
                <div class="stat-label">ì§€ì </div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="taskCount">0</div>
                <div class="stat-label">ì—…ë¬´</div>
            </div>
        </div>

        <!-- í†µí•© ìš”ì²­ ì•Œë¦¼ -->
        <div id="integrationAlerts"></div>

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <div class="card">
            <div class="tabs">
                <div class="tab active" data-tab="overview">ê°œìš”</div>
                <div class="tab" data-tab="members">êµ¬ì„±ì› ê´€ë¦¬</div>
                <div class="tab" data-tab="branches">ì§€ì  ê´€ë¦¬</div>
                <div class="tab" data-tab="processes">í”„ë¡œì„¸ìŠ¤</div>
                <div class="tab" data-tab="settings">ì„¤ì •</div>
            </div>

            <!-- ê°œìš” íƒ­ -->
            <div class="tab-content active" id="overview">
                <h3>íšŒì‚¬ ì •ë³´</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">íšŒì‚¬ëª…</div>
                        <div class="info-value" id="overviewCompanyName">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</div>
                        <div class="info-value" id="overviewTaxNumber">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ëŒ€í‘œì</div>
                        <div class="info-value" id="overviewRepresentative">-</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ì„¤ë¦½ì¼</div>
                        <div class="info-value" id="overviewEstablishmentDate">-</div>
                    </div>
                </div>
            </div>

            <!-- êµ¬ì„±ì› ê´€ë¦¬ íƒ­ -->
            <div class="tab-content" id="members">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>êµ¬ì„±ì› ê´€ë¦¬</h3>
                    <button class="btn btn-primary" onclick="openInviteMemberModal()">+ êµ¬ì„±ì› ì´ˆëŒ€</button>
                </div>
                
                <div class="table-container">
                    <table id="membersTable">
                        <thead>
                            <tr>
                                <th>ì´ë¦„</th>
                                <th>ì´ë©”ì¼</th>
                                <th>ë¶€ì„œ</th>
                                <th>ì—­í• </th>
                                <th>ìƒíƒœ</th>
                                <th>ê°€ì…ì¼</th>
                                <th>ì•¡ì…˜</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- êµ¬ì„±ì› ë°ì´í„°ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ì§€ì  ê´€ë¦¬ íƒ­ -->
            <div class="tab-content" id="branches">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>ì§€ì  ê´€ë¦¬</h3>
                    <div>
                        <button class="btn btn-primary" onclick="openAddBranchModal()">+ ì§€ì  ë“±ë¡</button>
                        <button class="btn btn-secondary" onclick="openIntegrationRequestModal()">ì§€ì  í†µí•© ìš”ì²­</button>
                    </div>
                </div>
                
                <div id="branchesContainer">
                    <!-- ì§€ì  ë°ì´í„°ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
            </div>

            <!-- í”„ë¡œì„¸ìŠ¤ íƒ­ -->
            <div class="tab-content" id="processes">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>ë¹„ì¦ˆë‹ˆìŠ¤ í”„ë¡œì„¸ìŠ¤</h3>
                    <button class="btn btn-primary" onclick="openAddProcessModal()">+ í”„ë¡œì„¸ìŠ¤ ì¶”ê°€</button>
                </div>
                
                <div class="table-container">
                    <table id="processesTable">
                        <thead>
                            <tr>
                                <th>í”„ë¡œì„¸ìŠ¤ëª…</th>
                                <th>ë‹´ë‹¹ì</th>
                                <th>ë¶€ì„œ</th>
                                <th>ë³µì¡ë„</th>
                                <th>ìƒíƒœ</th>
                                <th>ìƒì„±ì¼</th>
                                <th>ì•¡ì…˜</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- í”„ë¡œì„¸ìŠ¤ ë°ì´í„°ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ì„¤ì • íƒ­ -->
            <div class="tab-content" id="settings">
                <h3>íšŒì‚¬ ì„¤ì •</h3>
                <div class="alert alert-info">
                    <strong>ì•ˆë‚´:</strong> íšŒì‚¬ ì„¤ì • ë³€ê²½ì€ ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="exportCompanyData()">íšŒì‚¬ ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
                    <button class="btn btn-danger" onclick="deleteCompany()" style="margin-left: 10px;">íšŒì‚¬ ì‚­ì œ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentCompanyId = null;
        let currentUser = null;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
            setupTabNavigation();
        });

        async function initializeDashboard() {
            try {
                // í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
                const userResponse = await fetch('/api/auth/me');
                if (userResponse.ok) {
                    currentUser = await userResponse.json();
                    updateUserAvatar();
                }

                // íšŒì‚¬ ì •ë³´ ë¡œë“œ
                await loadCompanyInfo();
                await loadCompanyStats();
                await loadMembers();
                await loadBranches();
                await loadProcesses();
                await checkIntegrationRequests();
            } catch (error) {
                console.error('ëŒ€ì‹œë³´ë“œ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
            }
        }

        async function loadCompanyInfo() {
            try {
                const response = await fetch('/api/companies/my-company');
                const result = await response.json();
                
                if (result.success) {
                    const company = result.data;
                    currentCompanyId = company.id;
                    
                    document.getElementById('companyName').textContent = company.company_name;
                    document.getElementById('companyType').textContent = company.company_type === 'headquarters' ? 'ë³¸ì ' : 'ì§€ì ';
                    
                    // ê°œìš” íƒ­ ì •ë³´ ì—…ë°ì´íŠ¸
                    document.getElementById('overviewCompanyName').textContent = company.company_name;
                    document.getElementById('overviewTaxNumber').textContent = company.tax_number;
                    document.getElementById('overviewRepresentative').textContent = company.representative_name;
                    document.getElementById('overviewEstablishmentDate').textContent = 
                        company.establishment_date ? new Date(company.establishment_date).toLocaleDateString('ko-KR') : '-';
                }
            } catch (error) {
                console.error('íšŒì‚¬ ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        async function loadCompanyStats() {
            try {
                const response = await fetch('/api/companies/stats');
                const result = await response.json();
                
                if (result.success) {
                    const stats = result.data;
                    document.getElementById('memberCount').textContent = stats.memberCount || 0;
                    document.getElementById('processCount').textContent = stats.processCount || 0;
                    document.getElementById('branchCount').textContent = stats.branchCount || 0;
                    document.getElementById('taskCount').textContent = stats.taskCount || 0;
                }
            } catch (error) {
                console.error('í†µê³„ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        async function loadMembers() {
            try {
                const response = await fetch('/api/companies/members');
                const result = await response.json();
                
                if (result.success) {
                    const tbody = document.querySelector('#membersTable tbody');
                    tbody.innerHTML = '';
                    
                    result.data.forEach(member => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${member.first_name} ${member.last_name}</td>
                            <td>${member.email}</td>
                            <td>${member.department || '-'}</td>
                            <td>${getRoleDisplayName(member.role_type)}</td>
                            <td><span class="status-badge status-${member.status}">${getStatusDisplayName(member.status)}</span></td>
                            <td>${new Date(member.created_at).toLocaleDateString('ko-KR')}</td>
                            <td>
                                <button class="btn btn-small btn-secondary" onclick="editMember('${member.user_id}')">ìˆ˜ì •</button>
                                ${member.role_type !== 'founder' ? `<button class="btn btn-small btn-danger" onclick="removeMember('${member.user_id}')">ì œê±°</button>` : ''}
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('êµ¬ì„±ì› ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        async function loadBranches() {
            try {
                const response = await fetch('/api/companies/branches');
                const result = await response.json();
                
                const container = document.getElementById('branchesContainer');
                
                if (result.success && result.data.length > 0) {
                    container.innerHTML = result.data.map(branch => `
                        <div class="card">
                            <h4>${branch.company_name}</h4>
                            <div class="info-grid">
                                <div class="info-item">
                                    <div class="info-label">ì‚¬ì—…ìë²ˆí˜¸</div>
                                    <div class="info-value">${branch.tax_number}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">êµ¬ì„±ì› ìˆ˜</div>
                                    <div class="info-value">${branch.member_count}ëª…</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">ë“±ë¡ì¼</div>
                                    <div class="info-value">${new Date(branch.created_at).toLocaleDateString('ko-KR')}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">ì£¼ì†Œ</div>
                                    <div class="info-value">${branch.address || '-'}</div>
                                </div>
                            </div>
                            <div style="margin-top: 15px;">
                                <button class="btn btn-small btn-primary" onclick="viewBranchDetails('${branch.id}')">ìƒì„¸ë³´ê¸°</button>
                                <button class="btn btn-small btn-secondary" onclick="editBranch('${branch.id}')">ìˆ˜ì •</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ¢</div>
                            <h4>ë“±ë¡ëœ ì§€ì ì´ ì—†ìŠµë‹ˆë‹¤</h4>
                            <p>ìƒˆ ì§€ì ì„ ë“±ë¡í•˜ê±°ë‚˜ ê¸°ì¡´ ì§€ì ê³¼ í†µí•©ì„ ìš”ì²­í•˜ì„¸ìš”.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('ì§€ì  ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        async function loadProcesses() {
            // í”„ë¡œì„¸ìŠ¤ ë¡œë“œ êµ¬í˜„ (ì‹¤ì œ API ì—°ë™ í•„ìš”)
            const tbody = document.querySelector('#processesTable tbody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="empty-state">
                        <div class="empty-state-icon">âš™ï¸</div>
                        <div>ë“±ë¡ëœ í”„ë¡œì„¸ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                    </td>
                </tr>
            `;
        }

        async function checkIntegrationRequests() {
            try {
                const response = await fetch('/api/branch-integration/pending-requests');
                const result = await response.json();
                
                if (result.success && result.data.length > 0) {
                    const alertsContainer = document.getElementById('integrationAlerts');
                    alertsContainer.innerHTML = result.data.map(request => `
                        <div class="alert alert-warning">
                            <strong>ì§€ì  í†µí•© ìš”ì²­</strong><br>
                            ${request.headquarters_name}ì—ì„œ ì§€ì  í†µí•©ì„ ìš”ì²­í–ˆìŠµë‹ˆë‹¤.
                            <a href="branch-integration.html?requestId=${request.id}" class="btn btn-small btn-primary" style="margin-left: 10px;">í™•ì¸</a>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('í†µí•© ìš”ì²­ í™•ì¸ ì˜¤ë¥˜:', error);
            }
        }

        function setupTabNavigation() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // ëª¨ë“  íƒ­ê³¼ ì»¨í…ì¸  ë¹„í™œì„±í™”
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // ì„ íƒëœ íƒ­ê³¼ ì»¨í…ì¸  í™œì„±í™”
                    this.classList.add('active');
                    document.getElementById(this.dataset.tab).classList.add('active');
                });
            });
        }

        function updateUserAvatar() {
            if (currentUser) {
                const avatar = document.getElementById('userAvatar');
                avatar.textContent = currentUser.first_name ? currentUser.first_name.charAt(0).toUpperCase() : 'U';
            }
        }

        function getRoleDisplayName(role) {
            const roles = {
                'founder': 'ì„¤ë¦½ì',
                'admin': 'ê´€ë¦¬ì',
                'process_owner': 'í”„ë¡œì„¸ìŠ¤ ë‹´ë‹¹ì',
                'member': 'êµ¬ì„±ì›'
            };
            return roles[role] || role;
        }

        function getStatusDisplayName(status) {
            const statuses = {
                'active': 'í™œì„±',
                'pending': 'ëŒ€ê¸°',
                'inactive': 'ë¹„í™œì„±',
                'pending_approval': 'ìŠ¹ì¸ëŒ€ê¸°'
            };
            return statuses[status] || status;
        }

        // ëª¨ë‹¬ ë° ê¸°ëŠ¥ í•¨ìˆ˜ë“¤ (ì‹¤ì œ êµ¬í˜„ í•„ìš”)
        function openInviteMemberModal() {
            alert('êµ¬ì„±ì› ì´ˆëŒ€ ê¸°ëŠ¥ êµ¬í˜„ ì˜ˆì •');
        }

        function openAddBranchModal() {
            alert('ì§€ì  ë“±ë¡ ê¸°ëŠ¥ êµ¬í˜„ ì˜ˆì •');
        }

        function openIntegrationRequestModal() {
            alert('ì§€ì  í†µí•© ìš”ì²­ ê¸°ëŠ¥ êµ¬í˜„ ì˜ˆì •');
        }

        function openAddProcessModal() {
            alert('í”„ë¡œì„¸ìŠ¤ ì¶”ê°€ ê¸°ëŠ¥ êµ¬í˜„ ì˜ˆì •');
        }

        function editMember(userId) {
            alert(`êµ¬ì„±ì› ìˆ˜ì •: ${userId}`);
        }

        function removeMember(userId) {
            if (confirm('ì •ë§ë¡œ ì´ êµ¬ì„±ì›ì„ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                alert(`êµ¬ì„±ì› ì œê±°: ${userId}`);
            }
        }

        function viewBranchDetails(branchId) {
            alert(`ì§€ì  ìƒì„¸ë³´ê¸°: ${branchId}`);
        }

        function editBranch(branchId) {
            alert(`ì§€ì  ìˆ˜ì •: ${branchId}`);
        }

        function exportCompanyData() {
            alert('íšŒì‚¬ ë°ì´í„° ë‚´ë³´ë‚´ê¸° ê¸°ëŠ¥ êµ¬í˜„ ì˜ˆì •');
        }

        function deleteCompany() {
            if (confirm('ì •ë§ë¡œ íšŒì‚¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                alert('íšŒì‚¬ ì‚­ì œ ê¸°ëŠ¥ êµ¬í˜„ ì˜ˆì •');
            }
        }
    </script>
</body>
</html>